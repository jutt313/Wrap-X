# Wrap‑X Repository Deep Dive (2025-11-07)

This report documents the Wrap‑X project with a file‑by‑file explanation of authored source and configuration. It maps backend APIs, models, services, migrations, and the frontend app, and highlights inconsistencies plus a proposed improvement plan.

Scope and method
- Reviewed all top‑level project files, backend under `app/`, database migrations under `alembic/`, and frontend source under `frontend/src/`.
- Excluded third‑party/generated content (`node_modules/`, `.venv/`, `__pycache__`, compiled artifacts). These are external dependencies, not part of the authored code.


## Repository Overview

**Trial System**: All new users automatically receive a 3-day free trial subscription upon registration or first login. The trial is tracked in the `Billing` table with `status='trial'` and `amount=0.0`. Users see a trial countdown in the billing section and can upgrade to a paid plan at any time. The trial entry appears in billing history as a zero-amount transaction.

Top‑level
- `.env`: Local development environment variables.
  - Database: `DATABASE_URL` (async) and `DATABASE_SYNC_URL` (sync, for Alembic).
  - Auth: `SECRET_KEY`, `ALGORITHM`, `ACCESS_TOKEN_EXPIRE_MINUTES`.
  - OpenAI: `OPENAI_API_KEY` for config‑chat parsing.
  - Encryption: `ENCRYPTION_KEY` (Fernet) to encrypt/decrypt provider API keys.
  - Stripe: `STRIPE_SECRET_KEY`, `STRIPE_PUBLISHABLE_KEY`, `STRIPE_WEBHOOK_SECRET`, and product/price IDs.
  - Note: Contains real‑looking secrets; do not commit publicly and rotate if exposed.
- `.gitignore`: Ignores Python artifacts, venvs, Alembic pyc, SQLite/DB files, `.env`.
- `README.md`: Project overview, stack, schema summary (18 tables), setup steps.
- `DATABASE_SCHEMA.md`: Human‑readable table descriptions and relationships.
- `requirements.txt`: Backend dependencies (FastAPI, SQLAlchemy, Alembic, asyncpg/psycopg2, Pydantic, JWT, bcrypt, LiteLLM, OpenAI SDK, Stripe…).
- `setup_database.py`: Prints migration guidance if `.env` exists.
- `setup_database.sh`: Bash helper to venv/install deps and run `alembic revision`.
- `test_chat_browser.js`: Browser console helper to test creating a wrap and sending chat. Note: expects `localStorage.getItem('token')` but the app stores `auth_token` — mismatch.


## Backend (app/)

### Application core
- `app/main.py`
  - Configures FastAPI app (`Wrap-X API 1.0.0`).
  - Global exception handlers:
    - `RequestValidationError` → 422 with structured field messages.
    - Catch‑all → 500 with error message.
  - CORS for localhost dev ports 3000/5173.
  - Includes routers: `auth`, `dashboard`, `notifications`, `projects`, `llm_providers`, `wrapped_apis`, `billing`.
  - Health endpoints: `GET /` and `GET /health`.

- `app/config.py`
  - `Settings` via Pydantic: DB URLs, JWT settings, optional `openai_api_key`, `encryption_key`, Stripe credentials, product/price IDs, `frontend_base_url`.
  - Loads from `.env`; case‑insensitive.

- `app/database.py`
  - Async engine (`create_async_engine`) and session (`async_sessionmaker`) for runtime.
  - Sync engine (`create_engine`) and session for Alembic.
  - Exposes `Base = declarative_base()` and `get_db()` dependency.


### Auth (app/auth/)
- `utils.py`
  - Password hashing with bcrypt; `hash_password`, `verify_password`.
  - JWT helpers: `create_access_token`, `create_refresh_token`, `verify_token` (checks token type in payload).

- `dependencies.py`
  - `get_current_user`: Parses `Authorization: Bearer` via `HTTPBearer`, verifies JWT, loads `User` from DB.
  - `get_current_active_user`: Ensures `is_active`.


### Routers (app/routers/)
- `auth.py` (prefix `/api/auth`)
  - POST `/register`: Creates user (validates password match, unique email), auto‑creates default `Project`, issues access/refresh, stores `Session` (active 7 days), **auto-initializes 3-day free trial subscription**.
  - POST `/login`: Verifies password, deactivates old active sessions, issues new tokens, stores new session, **ensures free trial is initialized for returning users**.
  - POST `/refresh`: Validates refresh token (type `refresh`) and active session, rotates tokens and extends session.
  - POST `/logout`: Deactivates all user sessions.
  - GET `/me`: Returns current user profile.
  - POST `/forgot-password`: Always returns success (avoid user enumeration).
  - POST `/reset-password`: Placeholder (returns message; token flow TBD).
  - PUT `/profile`: Update `name` / `avatar_url`.
  - POST `/change-password`: Validates current password and updates to new hash.

- `dashboard.py` (prefix `/api/dashboard`)
  - `get_date_filter(time_range)`: today/7d/30d cutoff.
  - GET `/stats`: Aggregates APILog across user’s wraps since cutoff: total requests, success rate, count of active wraps, estimated cost (sum of `api_logs.cost`).
  - GET `/graphs/spending`: Dates list + per‑wrap stacked costs per date + totals.
  - GET `/graphs/success-rate`: Dates list + per‑wrap daily success% + overall daily averages.
  - GET `/graphs/cost`: Dates list + per‑wrap costs + totals (line chart data).
  - GET `/wrapped-apis`: Recent (24h) per‑wrap KPIs: requests, success %, total cost, with provider name.

- `notifications.py` (prefix `/api/notifications`)
  - GET ``: Paginated notifications for current user (unread first, then newest).
  - PATCH `/{id}/read`: Mark one as read.
  - PATCH `/mark-all-read`: Mark all unread as read.
  - DELETE `/{id}`: Delete one.
  - DELETE `/all`: Delete all for user.
  - GET `/settings`: Returns defaults or attempts to load from `current_user.notification_settings` (not a DB column; treated as metadata placeholder).
  - PUT `/settings`: Returns merged settings; MVP does not persist to DB.

- `projects.py` (prefix `/api/projects`)
  - GET ``: List current user projects (returns both internal `id` and `public_id`).
  - POST ``: Create project; generates `public_id` like `proj_<24 char token>`.
  - DELETE `/{project_id}`: Accepts numeric id or `proj_…` public id; validates ownership.

- `llm_providers.py` (prefix `/api/llm-providers`)
  - GET `/supported`: Popular providers hard‑coded (OpenAI, Anthropic, DeepSeek, Groq, Gemini, Mistral, Cohere, Together, Perplexity, Anyscale, Azure OpenAI, OpenRouter, Custom).
  - POST `/`: Validate project ownership → test API key via LiteLLM → encrypt API key → save `LLMProvider`.
    - Encryption: Fernet using `ENCRYPTION_KEY` from settings; if unset, generates transient key (warned — not safe for persistent decrypt across restarts).
  - GET `/`: List providers for user (optionally filtered by `project_id`), joins to `Project`, and aggregates usage stats from `APILog` (calls, tokens, last_used).
  - DELETE `/{provider_id}`: Prohibits deletion if any `WrappedAPI` uses the provider.

- `wrapped_apis.py` (prefix `/api/wrapped-apis`)
  - `generate_endpoint_id()`: `wrap_<uuid hex 24>`.
  - `hash_api_key()`: SHA256 hex digest of plain key.
  - POST `/`: Create `WrappedAPI` linked to provider (ownership enforced), set default project if none, create initial `PromptConfig`.
  - GET `/`: List all wraps for current user; includes embedded `PromptConfig`, provider and project display names.
  - GET `/{wrapped_api_id}`: Fetch one with config and display names.
  - PUT `/{wrapped_api_id}`: Update configurable fields: `name`, `is_active`, `thinking_mode`, `model`, `temperature`, `max_tokens`, `top_p`, `frequency_penalty`.
  - DELETE `/{wrapped_api_id}`: Delete wrap.
  - POST `/{wrapped_api_id}/chat/config`: Config assistant
    - Persists incoming `ChatMessage`, builds history (user/assistant turns), loads provider/project names for context.
    - Pulls last 20 successful APILogs to surface recent user/assistant message pairs.
    - Optionally fetches `available_models` via `services.model_catalog`.
    - Calls `services.chat_service.parse_chat_command()` to get structured updates and a conversational `response_message`.
    - Updates `PromptConfig` and wrap settings; handles `tools` via `WrappedAPITool` join.
    - Returns `ChatConfigResponse` with parsed updates and message.
  - GET `/{wrapped_api_id}/chat/config`: Returns prior `ChatMessage` entries (message+response+timestamps).
  - GET `/providers/{provider_id}/models`: Returns cached/fetched model list for provider.
  - POST `/{endpoint_id}/chat`: OpenAI‑compatible chat endpoint
    - Authentication:
      - If Authorization is a valid JWT for the wrap owner → allow without API key.
      - Else require `Authorization: Bearer <plain API key>` matching a stored hashed `APIKey` for that wrap.
    - Accepts either `{ message: "..." }` or `{ messages: [...] }` (OpenAI format). Calls `services.chat_service.call_wrapped_llm()` and logs an `APILog` with request, response, tokens, status.
    - Returns simple internal format (for single `message`) or the full OpenAI‑compatible response.
  - API Keys
    - GET `/api-keys/all`: List all keys across user’s wraps (with project/wrap names and last_used from APILog).
    - GET `/{wrapped_api_id}/api-keys`: List keys for one wrap (with last_used timestamp per wrap).
    - POST `/{wrapped_api_id}/api-keys`: Generate a 313‑character key (prefix `wx_`), store its SHA256 hash, return the plain key only once along with `endpoint_id` and endpoint URL.
    - DELETE `/api-keys/{api_key_id}`: Delete key (ownership enforced by wrap join).
  - Notes
    - Duplicated key list route blocks exist in file — appears to be copy/paste duplication.
    - Inconsistency: One `APIKeyResponse.endpoint_url` is set to `"/api/wrap-x/chat"` (should be `"/api/wrapped-apis/{endpoint_id}/chat"`).

- `billing.py` (prefix `/api/billing`)
  - Stripe init if `stripe_secret_key` set.
  - GET `/plans`: Exposes pricing plans derived from `services.billing_service.PLANS` (Starter/Professional/Business).
  - POST `/create-checkout-session`: Creates Stripe checkout session with 3‑day trial and returns `{ session_id, url }`.
  - GET `/subscription`: Returns current subscription for the user (or `null`). **Auto-creates a 3-day free trial subscription if none exists**.
  - POST `/webhook`: Verifies signature; syncs subscription events (created/updated/deleted/payment succeeded/failed) into `Billing` table.
  - GET `/history`: Returns last invoices for the Stripe customer (normalized fields). **Includes a zero-amount trial entry for users on trial**.
  - POST `/customer-portal`: Returns a Billing Portal session URL for subscription management. **Disabled for trial users**.


### Services (app/services/)
- `chat_service.py`
  - `get_openai_client()`: Lazily constructs `openai.OpenAI` client using `settings.openai_api_key`.
  - `parse_chat_command(message, current_config, history)`: Sends a carefully crafted meta‑prompt to OpenAI asking it to output a complete JSON configuration (role, instructions, rules, behavior, tone, examples, model, parameters, thinking/web search preferences, tools, response_message). Includes recent successful test chat logs for context when present.
  - `build_system_prompt(prompt_config)`: Composes the system prompt given the stored `PromptConfig` (role/instructions/rules/behavior/tone/examples) plus neutral guidance on planning without revealing chain‑of‑thought.
  - `call_wrapped_llm(wrapped_api, messages, tools, db_session)`:
    - Loads `LLMProvider`, decrypts its `api_key` via Fernet using `ENCRYPTION_KEY`. Clear error guidance if decryption fails (e.g., key changed — instruct to re‑add providers after setting the key).
    - Builds system+messages, chooses default model per provider if `wrapped_api.model` is empty.
    - Supports optional `temperature`, `max_tokens`, `top_p`, `frequency_penalty` from wrap; sets `api_base` when provider has a custom base.
    - Defines a `web_search` function tool. Executes Serper (Google) or Tavily if respective env keys are set; handles errors gracefully.
    - Tracks `wx_events`: thinking start/completion, tool call events, tool results. Returns OpenAI‑compatible response with `wx_events` merged and `usage` fields.

- `model_catalog.py`
  - `_default_base_url(provider_name)`: Returns common OpenAI‑compatible endpoints per provider (OpenAI, Anthropic, DeepSeek, Groq, Perplexity, Together, OpenRouter, Mistral, Cohere).
  - `_auth_header(provider)`: Chooses `Authorization: Bearer` vs `x-api-key` (Anthropic) per provider.
  - `_fetch_models_http(url, headers)`: Queries `/models` endpoint, handles typical response shapes.
  - `get_available_models(provider, ttl_seconds=21600)`: In‑memory cache keyed by provider id; on fetch failure, returns curated fallback list by provider family.

- `billing_service.py`
  - `PLANS`: Maps plan id → name, monthly price, wrap count limit, and Stripe price IDs from settings.
  - `TRIAL_DAYS`: Constant set to 3 days for free trial period.
  - `create_trial_subscription(user, db)`: Creates a new `Billing` record with `status='trial'`, `plan_type='trial'`, `amount=0.0`, and `stripe_trial_end` set to 3 days from creation. Used to auto-initialize trials for new users.
  - `get_or_create_stripe_customer(user, db)`: Reuses existing Billing row's customer ID or creates a new Stripe Customer and returns its id. **Updates trial records with customer ID when created**.
  - `create_checkout_session(user, price_id, db)`: Builds a hosted checkout session with trial and metadata; returns session id and URL.
  - `get_user_subscription(user, db)`: **Updated signature** — accepts `User` object instead of `user_id`. Returns active/trial subscription or latest record for user. **Auto-creates a 3-day free trial subscription if none exists**.
  - `update_subscription_from_stripe(subscription_id, db)`: Retrieves Stripe Subscription; upserts Billing fields including trial/cancel timestamps and period end.
  - `list_customer_invoices(customer_id, limit)`: Normalizes invoice items (amounts in currency units and timestamps to timezone aware datetimes).
  - `create_billing_portal_session(customer_id)`: Returns a Stripe Billing Portal session URL with `return_url` to frontend dashboard.


### Schemas (app/schemas/)
- `auth.py`: DTOs for register/login/token responses, password reset, user profile, profile updates, password change.
- `wrapped_api.py`: DTOs for wrap CRUD; prompt config update/response; chat request supporting `message` or `messages`; OpenAI response shape; API key create/list/response.
- `notification.py`: Notification settings defaults and partial update model.
- `llm_provider.py`: Create provider (name, project_id, provider_name, api_key, api_base_url), response DTO; `SupportedProvider` entries.
- `dashboard.py`: Dashboard KPI DTOs; `GraphDataset`, `GraphDataResponse` (dates/datasets and optional averages/totals); `WrappedAPIListItem` summary.
- `billing.py`: Plan/checkout/subscription/invoice/portal DTOs.


### Models (app/models/)
- `__init__.py`: Aggregates all ORM models for Alembic autogenerate and imports.
- `user.py`: `User` plus relationships: projects, providers, wraps, tools, chat_messages, sessions, rate_limits, billing_records, audit_logs, feedbacks, notifications (as foreign key on notification.user_id).
- `project.py`: `Project` (user_id, name, public_id, description, timestamps) with backrefs to `LLMProvider` and `WrappedAPI` (cascade deletes).
- `llm_provider.py`: `LLMProvider` (user_id, project_id, name, provider_name, api_key encrypted, optional api_base_url, timestamps). Backrefs from `WrappedAPI` declared there.
- `wrapped_api.py`: Core entity with owner, optional project and provider, name, unique `endpoint_id`, `is_active`, generation parameters (`thinking_mode`, `model`, `temperature`, `max_tokens`, `top_p`, `frequency_penalty`), timestamps, and relationships: `PromptConfig` (uselist=False), `APIKey`, `WrappedAPITool`, `Webhook`, `ChatMessage`, `APILog`, `RateLimit`, `Notification`, `Feedback`, `ConfigVersion`.
  - Note: Migration `196be9c33fc0` adds `thinking_focus`, `web_search`, `web_search_triggers` to `wrapped_apis`, but the ORM model does not declare these columns. Code accesses `thinking_focus` dynamically; values won’t persist until columns are added to the model.
- `prompt_config.py`: `PromptConfig` (unique `wrapped_api_id`) with role/instructions/rules/behavior/tone/examples; backrefs to `WrappedAPI` and `ConfigVersion`.
- `api_key.py`: Hashed API key (SHA256), named keys, optional expiry, `is_active` flag; FK to `WrappedAPI`.
- `api_log.py`: Request/response JSON payloads, tokens_used, cost, `status_code`, `is_success`, timestamps; FK to `WrappedAPI`.
- `chat_message.py`: Stores config chat user message and assistant response; FK to `User` and `WrappedAPI`.
- `session.py`: Access/refresh token storage, expiry, `is_active`, optional IP/user_agent; FK to `User`.
- `rate_limit.py`: Tracks rate limit counters / reset times scoped to user or wrap.
- `notification.py`: Notifications tied to wrap or user; type/title/message/is_read/meta_data (text JSON); timestamps.
- `billing.py`: Billing/subscription record with Stripe fields (`stripe_customer_id`, `stripe_subscription_id`, `stripe_price_id`, `stripe_current_period_end`, `stripe_trial_end`, `cancelled_at`) and plan/state tracking.
- `webhook.py`: Webhook registrations per wrap (url/secret/events JSON, is_active).
- `tool.py`: Tool registry per user (tool_name/tool_type/tool_config JSON) and join to wraps.
- `wrapped_api_tool.py`: Join table (wrapped_api_id, tool_id, trigger_condition, created_at) with backrefs.
- `config_version.py`: Versioned snapshots of `PromptConfig` with `version` and `config_snapshot` JSON.
- `audit_log.py`: Audit trail with action, resource_type/id, IP, user_agent, details.
- `feedback.py`: Ratings/comments per wrap.


## Database Migrations (alembic/)
- `alembic.ini`: Alembic configuration; URL injected from `settings.database_sync_url` in `env.py`.
- `env.py`: Adds `app/` to `sys.path`, imports `Base` and models for autogenerate, wires `sqlalchemy.url` from settings.
- `script.py.mako`: Template for new revisions.
- Versions (selected and observed behavior):
  - `7f2ea55251c8_initial_migration_all_18_tables.py`: Creates the initial 18 tables (users, projects, llm_providers, wrapped_apis, api_keys, prompt_configs, tools, wrapped_api_tools, webhooks, chat_messages, api_logs, sessions, rate_limits, config_versions, notifications, billing, audit_logs, feedback) with proper indices and FKs.
  - `ebc949d4d173_add_status_code_to_api_logs.py`: Adds `status_code` and `is_success` with indexes and a backfill rule for success on 2xx.
  - `0bb9d31f9220_add_avatar_url_to_users.py`: Placeholder (no schema changes implemented).
  - `7526a4d87f04_add_public_id_to_projects.py`: Adds `public_id` to `projects` (indexed unique) for public references.
  - `2b3cf6131453_add_name_to_llm_providers.py`: Adds display `name` to `llm_providers` (file content partially truncated in view; the net result is used in code).
  - `19fa42d78025_add_project_id_and_name_to_llm_providers.py`: Adds `project_id` (nullable → populated per user → NOT NULL) and FK to projects; seeds a default project per user for existing providers.
  - `40264bad3144_add_wrapped_api_settings.py`: Adds `thinking_mode`, `model`, `temperature`, `max_tokens`, `top_p`, `frequency_penalty` to `wrapped_apis` and `trigger_condition` to `wrapped_api_tools`.
  - `196be9c33fc0_add_thinking_focus_web_search_fields.py`: Adds `thinking_focus`, `web_search`, `web_search_triggers` to `wrapped_apis`.
  - `9b07c0a3f3f4_add_stripe_fields_to_billing.py`: Adds Stripe fields and unique indexes on `stripe_customer_id` and `stripe_subscription_id`.


## Frontend (frontend/)

Tooling and config
- `.env` / `.env.example`: Frontend environment placeholders.
- `eslint.config.js`, `vite.config.js`: Linting and Vite configuration (dev proxy assumed — client uses relative endpoints in dev).
- `index.html`: Vite entry.
- `package.json` / `package-lock.json`: React/Vite project setup.
- `public/`: Static assets.

Source (key files)
- `src/api/client.js`: Central fetch wrapper.
  - In dev, uses relative endpoint to hit Vite proxy; in prod, uses `API_CONFIG.baseURL`.
  - Merges headers, injects `Authorization: Bearer <auth_token>` if present. Verbose logging and error handling of 401/403 with token clearing.
  - Methods: `get`, `post`, `put`, `patch`, `delete`.
- `src/config/api.js`: API base URL and default headers (used by client.js).
- `src/contexts/AuthContext.jsx` and `src/hooks/useAuth.js`: Manages auth state and operations.
- `src/pages/`
  - `Dashboard.jsx`: Loads KPIs and graphs via `dashboardService`, provides UI for creating wraps and shows lists; heavy use of components and CSS.
  - `ChatPage.jsx`: Chat interface for a selected wrap; integrates `ConfigChat` and `TestChat` (not fully expanded in this view but referenced).
  - `Welcome.jsx`: Landing page for onboarding.
  - `auth/Login.jsx`, `auth/Register.jsx`, `auth/ForgotPassword.jsx`: Auth flows against backend `/api/auth/*` endpoints.
- `src/components/` (selected)
  - `CreateWrapModal.jsx`: Loads projects/providers, allows creating a wrap; optionally opens `LLMSettingsModal` to add providers.
  - `LLMSettingsModal.jsx`: Form to create an LLM provider (name, provider type, API key, base URL).
  - `CreateAPIKeyModal.jsx` and `GetAPIKeyModal.jsx`: Create and show API keys for a wrap.
  - `ConfigChat.jsx`: Conversational config assistant UI; calls backend `/{id}/chat/config` route.
  - `TestChat.jsx`: Simple chat to test a wrap endpoint.
  - Additional UI: `NotificationDropdown`, `ProfileDropdown`, `ProfileDrawer`, `ProjectsModal`, `APIsModal`, `BillingModal`, `TrialPlanModal`, `ChartContainer`, `KPICard`, `ProtectedRoute`, `Modal`.
    - `TrialPlanModal.jsx`: Modal that displays all pricing plans with "Start Free Trial" buttons. **Auto-shown on first login for trial users** (tracked via localStorage). Allows users to select a plan to upgrade from trial.
    - `ProfileDrawer.jsx`: Central profile hub with tabs (Profile, APIs, Projects, LLM Settings, Billing, Documentation). **Billing tab shows trial countdown, current plan details, upgrade button, and billing history including zero-amount trial entry**.
- `src/services/`
  - `authService.js`: `register`, `login`, `logout`, `getProfile`, `refreshToken`, `forgotPassword`, `resetPassword`. Stores `access_token` as `auth_token` and `refresh_token` in `localStorage`.
  - `dashboardService.js`: `getDashboardStats`, `getSpendingGraph`, `getSuccessRateGraph`, `getCostGraph`, `getWrappedAPIs`.
  - `llmProviderService.js`: `getSupportedProviders`, `getProviders(projectId?)` (uses trailing slash to avoid redirect header issues), `createProvider`, `deleteProvider`.
  - `projectService.js`: `getProjects`, `getDefaultProject`, `createProject`, `deleteProject`.
  - `notificationService.js`: `getNotifications`, `markAsRead`, `markAllAsRead`, `deleteNotification`, `deleteAllNotifications`, `getSettings`, `updateSettings`.
  - `wrappedApiService.js`: `createWrappedAPI`, `getWrappedAPIs`, `getWrappedAPI`, `updateWrappedAPI`, `deleteWrappedAPI`, `createAPIKey`, `listAPIKeys`, `deleteAPIKey`, `getAllAPIKeys`.
    - Note: Contains `getAPIKey(wrappedApiId)` hitting `/api/wrapped-apis/${wrappedApiId}/api-key` which does not exist in backend; correct route is `POST /api/wrapped-apis/{id}/api-keys`.
  - `billingService.js`: `getPlans`, `createCheckoutSession`, `getSubscription`, `getHistory`, `createPortalSession`.
- `src/styles/`: CSS for pages/components (e.g., `Dashboard.css`, `ConfigChat.css`, `BillingModal.css`, `TrialPlanModal.css`, `ProfileDrawer.css`, auth styles…).
- `src/App.jsx`, `src/main.jsx`, `src/App.css`, `src/index.css`: App bootstrap and global styles.


## API Catalog (summary)
- Auth: `/api/auth/register|login|refresh|logout|me|forgot-password|reset-password|profile|change-password`
- Projects: `/api/projects` (GET, POST), `/api/projects/{project_id}` (DELETE — accepts numeric id or `proj_…`)
- LLM Providers: `/api/llm-providers/supported` (GET), `/api/llm-providers/` (GET/POST), `/api/llm-providers/{id}` (DELETE)
- Wrapped APIs:
  - CRUD: `/api/wrapped-apis/` (GET/POST), `/api/wrapped-apis/{id}` (GET/PUT/DELETE)
  - Config chat: `/api/wrapped-apis/{id}/chat/config` (POST/GET)
  - Model list: `/api/wrapped-apis/providers/{provider_id}/models` (GET)
  - Chat: `/api/wrapped-apis/{endpoint_id}/chat` (POST, OpenAI‑compatible)
  - API Keys: `/api/wrapped-apis/api-keys/all` (GET), `/api/wrapped-apis/{id}/api-keys` (GET/POST), `/api/wrapped-apis/api-keys/{api_key_id}` (DELETE)
- Dashboard: `/api/dashboard/stats`, `/api/dashboard/graphs/spending|success-rate|cost`, `/api/dashboard/wrapped-apis`
- Notifications: `/api/notifications` (GET), `/api/notifications/{id}/read` (PATCH), `/api/notifications/mark-all-read` (PATCH), `/api/notifications/{id}` (DELETE), `/api/notifications/all` (DELETE), `/api/notifications/settings` (GET/PUT)
- Billing: `/api/billing/plans`, `/api/billing/create-checkout-session`, `/api/billing/subscription`, `/api/billing/history`, `/api/billing/customer-portal`, `/api/billing/webhook`


## Data Model (selected relations)
- User 1‑N Project, LLMProvider, WrappedAPI, Tool, ChatMessage, Session, RateLimit, Billing, AuditLog, Feedback; Notifications (via `Notification.user_id`).
- Project 1‑N WrappedAPI and 1‑N LLMProvider (cascade on delete).
- LLMProvider N‑1 User and N‑1 Project; 1‑N WrappedAPI.
- WrappedAPI 1‑1 PromptConfig; 1‑N APIKey, ChatMessage, APILog, RateLimit, Notification, Feedback; N‑M Tool via WrappedAPITool; 1‑N Webhook; 1‑N ConfigVersion.


## Notable Issues / Inconsistencies
1) Secret handling
- `.env` with secrets is committed. Action: remove from VCS, add `.env.example`, rotate all secrets.

2) Encryption key stability
- `llm_providers.py` will generate a random `ENCRYPTION_KEY` if missing; `chat_service` requires a stable key to decrypt. Action: require `ENCRYPTION_KEY` to be set; remove runtime generation; add admin messaging to re‑add providers if key changed.

3) ORM vs migration mismatch
- Migration `196be9c33fc0` adds `thinking_focus`, `web_search`, `web_search_triggers` to `wrapped_apis`; `app/models/wrapped_api.py` lacks these columns. Values referenced via `getattr` will not persist. Action: add missing columns in ORM and expose in routers/schemas as needed.

4) Wrapped API key routes duplication and endpoint_url inconsistency
- Duplicate route blocks (`/api-keys/all`, creation listing) appear twice in `wrapped_apis.py`.
- `APIKeyResponse.endpoint_url` sometimes set to `"/api/wrap-x/chat"` instead of `"/api/wrapped-apis/{endpoint_id}/chat"`. Action: deduplicate and standardize endpoint URL.

5) Frontend service route mismatch
- `wrappedApiService.getAPIKey` calls `/api/wrapped-apis/${id}/api-key` which does not exist. Action: change to `POST /api/wrapped-apis/${id}/api-keys`.

6) Test script token key mismatch
- `test_chat_browser.js` reads `localStorage.getItem('token')` but app uses `auth_token`. Action: update to use `auth_token`.

7) Model catalog robustness
- Some providers (e.g., Cohere, OpenRouter) may have different model listing patterns. Action: improve `_default_base_url`/`_fetch_models_http` or hide model listing when unsupported; keep fallback lists updated.


## Run / Test (dev)
- Backend: `uvicorn app.main:app --reload` (requires Postgres, `.env` configured, Alembic upgraded).
- Migrations: `alembic upgrade head` (ensure `DATABASE_SYNC_URL` is reachable).
- Frontend: `npm install` in `frontend`, then `npm run dev` (or `vite`), with Vite proxy to backend.
- Sample test flow:
  1) Register/login via `/api/auth` (frontend pages or cURL).
  2) Add an LLM provider via UI (ensure `ENCRYPTION_KEY` is set before saving providers).
  3) Create a wrap, use Config Chat to set role/instructions/model.
  4) Create an API key; call `POST /api/wrapped-apis/{endpoint_id}/chat` with `Authorization: Bearer <plain key>`.


## Proposed Improvement Plan
- Security & config
  - Remove `.env` from repo; provide `.env.example`; rotate keys.
  - Enforce presence of `ENCRYPTION_KEY`; remove auto‑generation; add startup check and clear error if missing.
- Schema alignment
  - Add `thinking_focus`, `web_search`, `web_search_triggers` columns to ORM model; update Pydantic schemas and routers to read/write them.
- API cleanup
  - Deduplicate wrapped API key routes; unify `endpoint_url` to `/api/wrapped-apis/{endpoint_id}/chat`.
  - Standardize error messages and logging across routers.
- Frontend fixes
  - Update `wrappedApiService.getAPIKey` to call `POST /api/wrapped-apis/{id}/api-keys`.
  - Update `test_chat_browser.js` to use `auth_token`.
  - Ensure all service calls include trailing slashes where backend expects them (or normalize backend routes to no trailing slash).
- Model catalog & tools
  - Harden model discovery per provider; if unsupported, surface curated list from `model_catalog` or the UI’s dropdown without HTTP fetch.
  - Add UI to manage tools (web_search toggles, trigger conditions) and expose in the chat service.
- Observability
  - Add cost estimation per provider based on tokens and provider pricing in `APILog`.
  - Add request tracing IDs in logs and responses for easier debugging.


---

If you want any section expanded further (e.g., full component‑by‑component UI mapping or cURL examples per endpoint), I can extend this document.

